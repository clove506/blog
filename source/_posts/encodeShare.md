---
title: 【合肥项目】编码问题分享
date: 2017-1-13 18:00:00
categories: 项目总结
tags:
- 项目总结
---

摘要
合肥项目-编码问题技术分享
<!-- more -->

## 说在前面

还记得第一次面试，晨哥问我的乱码问题，为什么会乱码？当时回答的一塌糊涂，也比较紧张，根本没有回答到点上。之后查了些资料，给大家分享一下吧。

## 字符集和编码

常用的字符集和编码有ASCII、ISO8859-1、gb2312、GBK、Unicode、UTF-8。

ASCII字符集&编码：编码范围0x00-0x7F，ASCII字符集包括英文字母、阿拉伯数字和标点符号等字符。是当时美国制定出来的一套编码系统,使用7位二进制来表示西文字符，0-31以及127为控制字符或通信用字符,其余为可显示出来的字符。在标准的ASCII中最高位b7作为奇偶校验位。后面128个则称为扩展ASCII码，以满足当时不同地方特殊符号的需求。
![](/Users/ljm/Downloads/87.png)

ISO8859-1字符集&编码：属于单字节编码，使用8位二进制存储，向下兼容ASCII，不能表示中文。其编码范围是0x00-0xFF，0x00-0x7F之间完全和ASCII一致。
![](/Users/ljm/Downloads/88.png)

gb2312字符集&编码：基于区位码设计，编码范围0xA1A1-0xFEFE。采用两个字节来编码,沿用ASCII中前127个字符的编码，127之后的字符全部去掉。两个字节中前一个称为高字节(0xA1-0xF7)，后一个为低字节(0xA1-0xFE),这样能组合映射出来7000多汉字。
![](/Users/ljm/Downloads/89.png)

GBK字符集&编码：向下兼容gb2312,编码范围0x8140-0xFEFE。虽然gb2312囊括了大部分汉字，但还是有一些像繁体字和符号就没有编入进来，于是再次进行扩展，便有gbk。GBK的字符编码是用双字节来表示的，为了区分中、英文，对存储中文字符的两个字节的最高位都定为1。

Unicode字符集&编码：是一个字符集，包含了世界上所有的字符。中文文字在Unicode的编码范围是：u+4e00-u+9fa5。它只规定了符号的二进制代码，却没有规定这个二进制代码应该如何存储。

UTF-8字符集&编码：UTF-8是在互联网上使用最广的一种Unicode的实现方式。UTF-8最大的一个特点，就是它是一种变长的编码方式。它可以使用1~4个字节表示一个符号，对英文字符使用一个字节存储，中文字符使用三个字节存储。
UTF-8的编码规则：
1、对于单字节的符号，字节的第一位设为0，后面7位为这个符号的Unicode码。因此对于英文字符，UTF-8和ASCII码是一样的。
2、对于n（n>1）字节的符号,第一个字节的前n位都设为1，第n+1为设为0，后面字节的前两位一律设为10。剩下的没有提及的二进制位，全部设为这个符号的Unicode码。

如果觉得我描述的不够清晰，这篇文章感觉还不错哦。[字符集和字符编码](http://wiki.jikexueyuan.com/project/visual-studio/15.html)

## 为什么出现乱码？

原因：编码和解码时用了不同或者不兼容的字符集。生活上就好比一个英国人为了表示祝福在纸上写了bless，而法国人看了且表示很受伤，因为在法语中bless表示受伤的意思。在计算机科学上也是一样，一个用UTF-8编码后的字符，拿去用GBK解码，由于两个字符集的字符库不一样，同一个汉字在两个字符表的位置也不一样，最终就会出现乱码。看下面一个‘栗子’：假设使用UTF-8编码存储“优护家”三个汉字，会有如下的转换：

字符 | UFF-8编码后的十六进制
------- | -------
优 | E4BC98
护	| E68AA4
家 | E5AEB6

那么使用GBK进行解码会出现什么结果？

由于GBK是双字节存储字符，“优护家”经过UTF-8编码形成的编码值将被拆分为：E4BC,98E6,8AA4,E5AE,B6。
这些十六进制数值对应的汉字与“优护家”三个汉字完全不同，而且字符的个数还发生了变化。这就产生了乱码。

"优护家"经过GBK编码存储转换十六进制是：

字符 | GBK编码后的十六进制
------- | -------
优 | D3C5  
护 | BBA4
家 | BCD2
从这里可以看出，在GBK中，能真正表示“优护家”这三个字的十六进制编码是D3C5BBA4BCD2.

代码演示。。。。。idea

## tomcat应用出现乱码的地方以及原因是什么？

### HTTP Header的编解码

当发起一个http请求时，header中会保存一些请求的信息，在调用request.getHeader方法进行header信息解码时，默认使用的编码也是ISO8859-1。然而iso8859-1不支持中文，所以如果Header中保存了中文信息，解码时肯定会有乱码。

### POST 表单的编解码

当用户提交表单时，表单的参数是根据content-type中的charset编码格式进行编码，然后提交到服务器端，在服务器端也是用content-type的字符集进行编码的，这个字符集是我们自己设置的，所以POST表单提交的数据一般不会出现问题，但是一定要在request.getParameter之前就设置request.getCharacterEncoding(charsetName)，否则POST表单提交的数据也可能会出现乱码。

### HTTP BODY的编解码

当用户请求的数据获取成功，这些数据经过Response返回给客户端。这个过程也先要经过编码，在到浏览器解码，编解码字符集可以通过Response.setCharacterEncoding来设置，通过Header的content-type赶回到客户端，然后浏览器根据content-type的charset来解码。如果content-type没有设置charset，那么浏览器将根据
```
<meta http-equiv=”Content-Type” content=”text/html; charset=UTF-8″>
```
中的charset来解码，如果也没有定义，浏览器将使用默认的编码来解码。

### 服务端和应用服务器之间出现乱码

tomcat默认的字符集是ISO8859-1,是不支持中文的。所以使用中文时就会出现乱码。解决方案：
1.在tomcat的安装目录下找到conf文件夹，打开该文件夹中的server.xml
2.将其中相应的配置修改如下：
``` 
<Connector port=”8080″ protocol=”HTTP/1.1″
 connectionTimeout=”20000″
 redirectPort=”8443″
 URIEncoding=”UTF-8″ />
```
这里的修改只对UTF-8起作用，如果使用其他类型的编码，就需要配置成其他的编码。

总而言之，产生乱码的原理：编码解码时所用的格式不一致；解决乱码：统一编解码格式。

