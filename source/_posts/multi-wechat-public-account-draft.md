---
title: 微信多公众号打通方案【Draft】
date: 2017-2-18 13:00:00
categories: 系统架构
tags:
- 公众号
---

## 摘要

微信多公众号打通方案
<!--more-->

## Wiki维护人

Arch组 
刘明敏

### 原因
    
经营范围错误，需要迁移

之后支持多个公众号

### 方案

主公众号 + 影子公众号

影子公众号登录需要304跳转到主公众号登录。

举个例子：

我们的服务地址是: www.youhujia.com/departments

用户扫码关注影子公众号，关注。

用户访问服务地址，前/后端发现未登录，前端根据所在环境（公众号）跳转到对应的影子公众号登录地址登录，登录后304跳转到服务地址，后端判断当前影子openId是否关联了主公众号openId，如果没有，直接304跳转到主公众号的登录地址登录，登录后304跳转到服务地址。


### 排期

13人日开发

7人日测试

3人日验证上线

### FAQ
#### 老用户数据如何迁移
分两种情况：
- 影子未登录。影子公众号登录304跳转到主公众号登录再304跳转到具体服务地址。
- 影子已登录。先判断主公众号是否有用户信息，如果没有304跳转到主公众号登录。如果有直接跳转到服务地址。

#### 登录和关注的关系
先关注 在 登录 在享受服务。
#### 主公众号登录的目的
为了收集主公众号和影子公众号的openId直接的关系，在支付场景需要使用主公众号的openId。
#### 影子公众号登录的目的
为了收集影子公众号的openId，收集后的openId是为了PUSH使用。
#### 如何判断当前所处公众号
前端需要所处标识，后端只给出如下信息：
- 当前公众号是否登录
- 主公众号有登录记录（openId）

#### 支付是否有问题

支付时使用的是主公众号，各种PUSH通过影子公众号提供。

在我们的约束里，主公众号和影子公众号是成对出现的，否则不能提供服务。

#### PUSH是否有问题

不会受影响，整个的服务通过用户登录的公众号来PUSH。


