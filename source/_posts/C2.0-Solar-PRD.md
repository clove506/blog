---
title: C端2.0 科室管理
date: 2017-4-11 10:40:00
categories: C++
tags:
- 科室管理
---


# 科室管理

## 模型设计

通用科室采用对原有的 `Department` 模型增加一个 `type` 属性来完成区分。同时，更改现有对 Organization 和 Department 的接口进行过滤。Servce 迁移到 Solar 项目

**Department**
增加一个 `type` 字段，用以区分正常的 Department 和 虚拟 Department。

另外需要一个增加一个`Logo`字段，存储科室 Logo，默认用优护家的 Logo。

**访客科室**
访客科室的逻辑不变。

<!-- more -->
### 普通科室

- `type=COMMON` 普通科室的内容不变，增加 `type` 字段以区分「普通科室」和「通用科室」
- 通用疾病属性：即内外妇儿等，现有科室都会关联一个通用的疾病，用来快速复制科室配置。

### 通用科室（虚拟科室）
`type=VIRTUAL`

虚拟科室的分为「内外妇儿」四大科，每个科下属又有若干疾病。这个传统疾病的分类，会用一个tag 树来展示。

### 优护家官方

优护家官方科室的 `type=COMMON` 但是会在普通科室中将其排除，将其 `departmentId` 固定，由单独的接口返回。

优护家的官方科室，会将所有优护家的官方内容放入其中，实现：

- 普通科室和虚拟科室通过疾病共享优护家内容
- 普通科室可以发布该科室的自建内容到优护家

优护家官方科室本质上和普通科室没区别，但是在接口上，将会把科室区分为三类：

1. 普通科室
2. 虚拟科室
3. 优护家官方科室

### 通用疾病分类(内外妇儿)
通用疾病分类树会用单独的一个 Tag System 中的 Tag 树来表示。

- 虚拟科室会关联该树的一个节点，表示该虚拟科室是属于哪类模板科室
- 普通科室也会关联该树的一个节点，表示该科室的配置应该从哪个虚拟科室复制。

### 科室和疾病的关联
科室和疾病的关联存储在「Tag 系统」中。

其中：

- 通用科室和疾病的关联 需要单独配置
- 万家科室的配置
  若为新科室，即该科室下没有护士管理员，需要将科室关联的通用疾病分类对应的「通用科室」配置复制到该科室下。

### 科室自建分类
采用 Tag 模型实现。默认有一个根节点 Tag，`departmentId` 为当前科室 ID，`type` 为科室自建分类。科室的所有分类 Tag 是该 Tag 的子节点。

### 优护家官方分类
和科室自建分类一致，但是分级可以有三级。

### 科室 UI 配置树
采用三级 Tag 分类实现。其中第二、三级可以缺失。

同样会有一个根节点 Tag，Type 为 UI 配置树类型。

```json
{
  "tag": {
    "tagId": 1,
    "type": "UI配置树",
    "departmentId": 1,
    "props": {
      "rank": 1,
      "element": [1, 2, 3]
    }
  }
}
```

以下是科室的 UI 配置的完整的举例：

```json
{
  "tag": [
    {
      "tagId": 1,
      "type": "UI配置树",
      "departmentId": 1,
      "level_1": 1,
      "props": {
        "rank": 1,
        "type": "根节点"
      }
    }, {
      "tagId": 2,
      "type": "UI配置树",
      "departmentId": 1,
      "level_1": 1,
      "level_2": 2,
      "props": {
        "rank": 1,
        "type": "一级节点",
        "content": {
          "element": [
            {
              "type": "UI-DepartmentTitle",
              "content": {
                "bannerUrl": "http://xxx",
                "departmentName": "脊柱外科",
                "organizationName": "解放军309医院"
              }
            }, {
              "type": "UI-ChatWithNurse"
            }
          ]
        }
      }
    }, {
      "tagId": 5,
      "type": "UI配置树",
      "departmentId": 1,
      "level_1": 1,
      "level_2": 2,
      "level_3": 5,
      "props": {
        "rank": 1,
        "type": "UI-DepartmentTitle",
        "content": {
          "bannerUrl": "http://xxx",
          "departmentName": "脊柱外科",
          "organizationName": "解放军309医院"
        }
      }
    }, {
      "tagId": 6,
      "type": "UI配置树",
      "departmentId": 1,
      "level_1": 1,
      "level_2": 2,
      "level_3": 6,
      "props": {
        "rank": 2,
        "type": "UI-DepartmentTitle",
        "content": {
          "bannerUrl": "http://xxx",
          "departmentName": "脊柱外科",
          "organizationName": "解放军309医院"
        }
      }
    }, {
      "tagId": 3,
      "type": "UI配置树",
      "departmentId": 1,
      "level_1": 1,
      "level_2": 3,
      "props": {
        "rank": 2,
        "type": "一级节点",
        "content": {
          "element": [
            {
              "type": "UI-SelfTest",
              "content": {
                "evaluationId": 1,
                "evaluationName": "营养自测",
                "iconId": 1,
                "iconColor": "red",
              }
            }
          ]
        }
      }
    }, {
      "tagId": 4,
      "type": "UI配置树",
      "departmentId": 1,
      "level_1": 1,
      "level_2": 4,
      "props": {
        "rank": 3,
        "type": "一级节点",
        "content": {
          "element": [
            {
              "type": "UI-Service",
              "content": {
                "itemId": 1,
                "name": "尿管护理服务",
                "price": 12000,
              }
            }
          ]
        }
      }
    }
  ]
}
```

根据以上的 Tag 模型，在给前端数据时，组织为一个完整的树型 JSON。给前端的 protobuf 见 Protobuf 部分。


## 接口设计

有关人与组织机构的分为两个系统： Yolar & Solar

- Yolar 底层的 Service，负责基本「人」和「机构科室」模型的基本操作
- Era 处理业务部分

接口索引
**Yolar**

将原有的科室相关接口迁移至 Solar 。


**Solar**

| 内容   | 功能         | Request Method & URL                     |
| ---- | ---------- | ---------------------------------------- |
|      | 创建医院       | POST /api/solar/v1/organizations         |
|      | 创建普通科室     | POST /api/solar/v1/departments           |
|      | 创建虚拟科室     | POST /api/solar/v1/departments/virtual   |
|      | 获取医院下普通科室  | GET /api/solar/v1/organizations/{organId}/departments |
|      | 获取单个普通科室   | GET /api/solar/v1/departments/{departmentId} |
|      | 获取所有虚拟科室     | GET /api/solar/v1/departments/virtual    |
|      | 获取优护家官方科室  | GET /api/solar/v1/departments/youhujia   |
|      | 更新科室       | PATCH /api/solar/v1/departments/{departmentId} |
|      | 更新科室 UI 配置 | PATCH /api/solar/v1/departments/{departmentId}/ui-config |
|      | 科室关联疾病     | PUT /api/solar/v1/departments/{departmentId}/diseases |
|      | 查询科室相关疾病   | GET /api/solar/v1/departments/{departmentId}/diseases |
|      | 复制科室 UI 配置 | POST /api/solar/v1/departments/duplicate-config-ui?from={dptId}&to={dptId} |
|      | 复制科室疾病关联配置 | POST /api/solar/v1/departments/duplicate-config-diseases?from={dptId}&to={dptId} |


### 1. 创建医院
~~> POST /api/solar/v1/organizations~~
* Request `OrganizationCreateOption`
* Response `OrganizationDTO`

### 2. 创建普通科室
~~>  POST /api/solar/v1/departments~~

* Response `DepartmentDTO`

### 3. 创建虚拟科室
~~>  POST /api/solar/v1/departments/virtual~~

* Response `DepartmentDTO`

### 4. 获取医院下普通科室
~~>  GET /api/solar/v1/organizations/{organId}/departments~~

* Response `DepartmentListDTO`

### 5. 获取单个普通科室
~~>  GET /api/solar/v1/departments/{departmentId}~~

* Response `DepartmentDTO`

### 6. 获取所有虚拟科室
>  GET /api/solar/v1/departments/virtual

* Response `DepartmentListDTO`

### 7. 获取优护家官方科室  
>  GET /api/solar/v1/departments/youhujia

* Response `DepartmentDTO`

### 8. 更新科室
~~>  PATCH /api/solar/v1/departments/{departmentId}~~

* Response `DepartmentDTO`

### 9. 更新科室 UI 配置
>  PATCH /api/solar/v1/departments/{departmentId}/ui-config

* Response `DepartmentDTO`


### 10. 科室关联疾病     
>  PUT /api/solar/v1/departments/{departmentId}/diseases

* Response `DepartmentDTO`


### 11. 查询科室相关疾病   
>  GET /api/solar/v1/departments/{departmentId}/diseases

* Response `DepartmentDTO`


### 12. 复制科室 UI 配置
>  POST /api/solar/v1/departments/duplicate-config-ui?from={dptId}&to={dptId}

* Response `SimpleResponse`


### 13. 复制科室疾病关联配置
>  POST /api/solar/v1/departments/duplicate-config-diseases?from={dptId}&to={dptId}

* Response `SimpleResponse`


## Protobuf

```protobuf
enum Type {
  COMMON = 1;
  VIRTUAL = 2;
}

message Organization {
  optional int64 organizationId = 1;
  optional string organizationName = 2;
  optional string address = 3;
}

message OrganizationCreateOption {
  optional string organizationName = 1;
  optional string address = 2;
}

message OrganizationDTO {
  optional Result result = 1;
  optional Data data = 2;

  message Data {
    optional Organization organization = 1;
  }
}

message Department {
  optional int64 departmentId = 1;
  optional string departmentName = 2;
  optional int64 organizationId = 3;
  optional string organizationName = 4;
  optional Type type = 5;
  optional string logo = 6;
  optional int64 commonDiseaseId = 7;
}

message DepartmentCreateOption {
  optional string departmentName = 1;
  optional int64 organizationId = 2;
  optional Type type = 3;
  optional string logo = 4;
  optional int64 commonDiseaseId = 5;
}

message DepartmentUpdateOption {
  optional string departmentName = 1;
  optional int64 commonDiseaseId = 2;
}

message DepartmentDTO {
  optional Result result = 1;
  optional Data data = 2;

  message Data {
    optional Department department;
  }
}

message DepartmentDTO {
  optional Result result = 1;
  optional Data data = 2;

  message Data {
    repeated Department department;
  }
}

enum UIConfigType {
  ROOT = 1;
  LEVEL_ONE = 2;
  LEVEL_TWO = 3;
  LEVEL_THREE = 4;
  SELF_TEST = 5;
  SERVICE_ITEM = 6;``
  CHAT_WITH_NURSE = 7;
}

message UIConfig {
  optional UIConfigType type = 1;
  optional string title = 2;
  repeated UIConfiguration child = 2;
  repeated UIConfig element = 3;
}
```

## Solar 排期

| 内容                   | 开发者  | 时间安排 |
| -------------------- | ---- | ---- |
| 虚拟科室                 | 李江明  | 1天   |
| 现有接口改造，支持虚拟、优护家、普通科室 | 李江明  | 1天   |
| 优护家官方科室相关接口          | 李江明  | 1天   |
| 通用疾病(内外妇儿)相关接口       | 李江明  | 1天   |
| 科室和优护家疾病树相关接口        | 李江明  | 1天   |
| UI配置树底层 Tag 系统实现     | 李江明  | 1天   |
| UI配置树接口              | 李江明  | 1天   |
| 科室配置复制接口             | 李江明  | 1天   |



