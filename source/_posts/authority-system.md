---
title: 优护家权限系统
date: 2016-11-14 20:44:13
categories: 系统框架
tags:
- 权限
- 管理云
---
## 摘要
权限管理系统贯穿各个后端应用，对应管理云中的CRM中对用户的描述以及用户对资源的控制。
<!--more-->

## 背景
### 权限定义
权限即控制。如明敏是超级管理员，他能访问后台管理系统的所有功能。又如郭苗是科秘，她在访问科室所有病人页面的时候可以看到和普通护士不同的内容。
控制表现在两个方面，一个是对功能使用的限制，一个是对功能效果的限制。前者如明敏能使用某某功能，但是陈晨不能。后者如在郭苗在访问患者页面这一个功能时候会有不同的效果，即是对功能效果的控制。
功能使用的限制涉及两个主体，一个是使用者（操作的人），另一个是动作。
内容效果的限制只涉及一个主体，即使用者，效果的因使用者的不同而不同。
### 调研
基本的权限控制框架（Apache Shiro和Spring security）往往是封装在大的“安全”框架下，从spring security的名字就可以看的出来，其涵盖的内容也是很广泛。
框架中涉及的权限一般涉及两个方面：authenticate和authorization。前者是认证“who am i”,确认请求主体；后者是“what user can do”，确认请求主体能访问哪些功能。框架并没有对功能效果的限制做抽象，因为这涉及具体的业务代码。
### 其他
“管理云”的背后即是我们现在看到的这套系统的抽象。从产品来看，权限的设置，权限的生效，权限的监控回溯都是包含在这套系统中，具体的思路可以看后面系统的详细设计。
## 详细设计
整个系统的搭建没有使用现有的框架，调研的框架只提只限制在了API级别，总体灵活性不高且学习成本很大，综合考虑，这里打算自建整个框架，框架从产品感知上分两部分，一个是功能使用的限制，一个是内容效果的限制。
### 功能使用限制
即结合使用者的身份对功能访问的限制。明敏是超级管理员，他能访问所有的后端管理接口。高擎祖只是普通护士，他不能访问管理接口。功能使用限制有如下两个重要的阶段：

- Authenticate（who am i）该部分是对身份的缺乏。
- Authorization（what i can do）改部分是从身份信息中添加针对该身份的限制。

系统达到的效果期望是针对未来的“管理云”，对新的权限，新的角色的各种权限控制做到开发成本尽可能的低。
#### 用户模型
用户模型是对使用者的抽象，大的层面有如下角色划分

- 护士
- 优护家管理员
- 患者
- 合作伙伴

更细的层面如针对护士，又如普通护士，护士管理员，认证通过的普通护士，认证通过的且带有ICU标签的护士。

这里需要区分一个概念，即如何定义用户，权限系统的”认知中“：普通护士，认证通过的普通护士，认证通过的带ICU标签的护士是不同的用户，用户在权限传统中的定义是“身份”+“修饰”，两者共同定位一个用户。

这里的修饰对系统是有限制的，在系统的设置中其是不能包含业务信息的。如：有随访记录的认证通过的护士，有随访记录即是业务信息。该限制是基于性能考虑，在框架底层上是这点并没有做限制。

整个用户模型的关系如图1：
![authority_user_mode](/media/authority_user_model.png)

图1. 用户信息+Tag模型

Person + 身份信息；Person是对人基本信息的描述，如电话号码，性别。身份信息如护士的职称，护士所在医院等。

#### 框架
主要的类图如下：
![authority_main_class](/media/authority_main_class.png)
图2 权限系统-功能使用限制主类图

![authority_auhenticate_main_class](/media/authority_auhenticate_main_class.png)
图3 权限系统-功能使用限制-身份校验主类图

![authority_authorize_main_class](/media/authority_authorize_main_class.png)

图4 权限系统-功能使用限制-授权校验主类图

![authority_authorize_dp](/media/authority_authorize_dp.png)

图5 权限系统-功能使用限制-授权校验主类图


### 内容效果限制 
结合使用者的信息对使用效果的的限制。
思路是构建贯穿整个请求Thread的权限Context，业务在根据Context对效果进行限制和调整。期望达到的效果就是尽可能的将业务的实现和权限系统对业务效果的调整分开。

有如下几个技术点：
- AuthorityContext的构建。
- AuthorityContext生效机制。

#### AuthorityContext构建
内容效果的限制主体只有一个，即使用者，整个Context的构建则是对使用者信息的补全。
#### AuthorityContext生效机制
因为和具体的业务结合的比较紧密，具体的业务在实现的时候可以通过分支判断等来实现这样的功能，但是考虑到权限和的添加维护本身也是有成本的，某些规则的失效，生效，新的规则上线可能都会对旧的规则有影响，所以这里还是计划通过架构（解决方案，不是强制要求）的设计来解决。

这里也有几个重要的阶段：
- 基础业务信息补全（BusinessContext）。如通讯录列表功能，就需要补全请求人所在科室的全部护士信息。
- 基于AuthorityContext和BusinessContext的构建状态机。
- 基于状态机构建业务流。

另外还有一种思路是利用装饰器对业务接口进行改造，这里不展开。
##### 架构图
TODO 





