---
title: 【上门护理二期】订单项目二期报警支持
date: 2017-02-10 20:20:00
categories: 上门护理二期
tags:
- 上门护理
- 合肥
- 订单
- 二期
---

# 摘要

原有的系统中档退款异常和发起退款异常都是需要报警的，第一期没有实现。

<!--more-->

# WIKI 维护人

李江明


# PM
李江明

# 阿里云日志服务支撑
由于合肥1期已有日志基础，再加上这次根据日志信息来报警的需求，我们可以沿用阿里云的日志服务支撑，记录日志，恰好阿里云日志服务提供Java API实现对阿里云日志的实时消费，包括对日志的读写，根据日志进行报警的功能。

# 实现方案

实现路径：记录日志->扫描日志->根据报警规则触发报警->解除报警

# 阿里云日志服务报警调研结果

## 记录日志

### 阿里云日志服务支持客户端、网页、syslog、SDK/API等方式采集日志

1. 使用 logtail 接入服务，通过简单的配置就可以收集服务器上的日志，而且不用修改任何应用程序代码。
2. 如果希望编程写入日志，loghub 提供多种语言（Java/.NET/PHP/Python）的 SDK 方便您使用。[快速入门/java版](https://help.aliyun.com/document_detail/29068.html?spm=5176.doc28981.6.721.9rh9AG)
3. 通过 Tracking 功能 支持 HTML、H5、iOS 和 Android 平台数据的采集，使用 tracking 方式写入日志要求您先开通 logstore 上的 Tracking 功能。开通方法请参考 [Web Tracking 接入用户端日志。](https://help.aliyun.com/document_detail/31752.html?spm=5176.doc28981.2.3.K7ihw1)。
4. 如果需要通过其他语言代码写入日志，可以使用日志服务的 Rest 风格 API 来完成。

具体介绍请看[日志采集方式](https://help.aliyun.com/document_detail/28981.html?spm=5176.doc29000.6.594.aB7VhX)
==我们的日志采集方式用的是Logtail的模式==

## 扫描日志（查询）

### 日志服务控制台查询日志

1. 可以设置快速查询、可以设置全文索引、针对需求可以使用指定键值对进行查询。
2. 可以在查询页面指定查询日志的主题，关键字以及日志时间范围。
3. 阿里云日志服务提供一套日志查询语法，可以参考[查询语法](https://help.aliyun.com/document_detail/29060.html?spm=5176.doc28969.2.3.nm7QND)

### 日志服务SDK/API查询日志

java实现请参考[快速入门/java版](https://help.aliyun.com/document_detail/29068.html?spm=5176.doc29007.6.721.oJOU5g)

### 设置报警规则

#### 日志服务控制台实现

日志服务支持基于查询结果进行报警，可以配置报警规则将具体的报警内容以短信的方式发送到指定的手机。
基本流程：
1. 配置快速查询
2. 系统定时运行快速查询，判断是否触发报警条件
3. 发送短信/查看报警结果
日志服务给出了规则说明，可以根据规则配置自己的报警规则。
==每个报警只能设置一个报警电话号码，同一个号码一天最多只能收到20条短信==
如配置一个快速查询：app:owl and level:error and errorCode:200025,这表示查询app是owl、log等级是error并且errorCode为200025的日志。

#### SDK实现

可以使用spring的@Scheduled(fixedDelay=PER_TIME)注解，实现定时查询。这个注解表示每隔多长时间运行一次查询方法，fixedDelay的值为时间间隔，单位为毫秒，如PER_TIME = 5 x 60 x 1000 ，即5分钟。

### 实施报警

#### 日志服务控制台实现

当日志服务发现了匹配报警规则的日志，则进行短息通知，实施报警。

#### SDK实现

当扫描到符合报警规则的日志，则调用发送短信的接口，将异常发送给预设的电话号码，进行提醒。也可以将异常log以bug的形式记录到bug云中，产生一个新的bug，等待人工解决

### 解除警报

#### 日志服务控制台实现

可查看报警记录，检查是否触发报警成功。没有明确定义怎样才视为解除报警。

#### SDK实现

SDK方式实施报警，可以通过人工处理bug云中的问题，将异常log产生的bug解决并关闭，此时意味着解除报警。

### 两种实现方式比较

日志服务控制台实现的方式:查询快，有查询语法的支持，提供报警服务，可以自定义报警规则，无需写代码，操作简单。但一个报警配置之支持一个手机号，且一个手机号一个短信通知的上限为20条。

SDK实现方式：扫描日志速度慢。


