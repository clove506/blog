---
title: 多微信公众号打通 和 优护家公众号迁移 方案草稿
date: 2017-2-20 15:55:00
categories: wechat
tags:
- wechat
---

# 摘要

多公众号打通 和 优护家公众号迁移 的方案草稿

<!-- more -->

# 多公众号打通

## 背景

现在我们的微信端用户有部分是从其他公众号导流而来，比如，很多用户通过合肥市一的公众号使用我们的微信端服务，这些用户很多只对我们的公众号做了登陆授权但并未关注我们，对这批用户，如果我们希望也能对他们推送消息，只能通过他已经关注的合肥市一的公众号来发送，由此产生了多公众号打通的需求。

## 方案

除了我们自己的公众号，上述我们希望借之对用户做推送的公众号我们称之为影子公众号。

要达到借用影子公众号对用户做推送的目的，前提是我们拥有该微信公众号的 appid 和 secret。

借用影子公众号发送消息只需获取用户在该公众号下的 openid 即可，该消息可以通过调用微信接口，以 snsapi_base 为 scope 获取，此过程用户是无感知的。(**待测试如何获取**)

步骤大致如下：

1. 科室配置 影子公众号 信息，需要公众号的 appid 和 secret。

2. 对于未配置  影子公众号 的科室，用户进入后，按现在流程走，不受影响。

3. 对配置了**影子公众号**的科室，用户进入后，正常登录，登录后，会检查当前用户在该科室下有无关联影子公众号的openId，如果有，则按正常流程走；若无，需要将该用户 redirect 到微信的认证页面，获取该用户在影子科室下的openId，此操作无需用户介入（**需验证**），获取到在影子公众号的用户 openId 后，将此信息关联到用户记录下，下次用户登陆时，就不再需要以上操作，直接正常流程即可。


# 优护家公众号迁移

## 背景

之前的 优护创智 公众号因为经营范围不妥，需要更换到新公众号：优护家。

## 方案

当前我们用户的模型是：

  WxProfile - **Person** - User

更换公众号，步骤如下：

1. 对微信公众号更换配置后，老用户登录，因为是全新的 openId，会生成一套全新的用户账号。
2. 之后我们会去获取改用户在旧公众号下的openID，检查是否是老用户。
3. 如果不是，按正常流程处理。
4. 如果是，将该用户切换到老的用户体系下，并更新用户 wxProfile 的 openId 为最新值。同时为了避免每次用户登陆都做以上检查，可以设置 flag，以记录用户是否做过了该检查。

# 时间估算

优护家公众号迁移： 4人日

多公众号打通：8人日

以上时间为大概估算，更细的估算会在详细设计出来后更新。

# Todo

1. 测试如何获取影子科室 openid
2. 支持多个公众号的后台


# 参考

http://wiki.office.test.youhujia.com/2017/02/18/multi-wechat-public-account-draft/

# 附

**关于网页授权的两种scope的区别说明**

1、以snsapi_base为scope发起的网页授权，是用来获取进入页面的用户的openid的，并且是**静默授权**并自动跳转到回调页的。用户感知的就是直接进入了回调页（往往是业务页面）

2、以snsapi_userinfo为scope发起的网页授权，是用来获取用户的基本信息的。但这种授权**需要用户手动同意**，并且由于用户同意过，所以无须关注，就可在授权后获取该用户的基本信息。 

~~3、用户管理类接口中的“获取用户基本信息接口”，是在用户和公众号产生消息交互或关注后事件推送后，才能根据用户OpenID来获取用户基本信息。这个接口，包括其他微信接口，都是需要该用户（即openid）关注了公众号后，才能调用成功的。~~ 