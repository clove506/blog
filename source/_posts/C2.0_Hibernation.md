---
title: C端2.0改版 Hibernation PRD
date: 2017-4-11 17:30:00
categories: C++
tags:
- 优护助手
---



# 自然人

## 概述

什么是自然人，百度上给出的解释是：自然人（natural person） 是在自然状态下出生的人。是不是感觉说了和没说没区别。那我们这个这次项目所需要设计的自然人模型又是什么呢？首先说一下我们这个自然人是针对优护家的患者，而自然人模型则是自然人的我们所需的病人所有信息数据的集合，是基于数据战略沉淀的一套用来多角度描述患者的数据模型。设计用户的内容也不只是简单的姓名、性别等这些基本信息，而是包括病人的身体健康情况、疾病历史、出入院信息以及科研信息等这些由患者身体将康以及所衍生出来的信息。

<!-- more -->
## 自然人模型

自然人模型个人理解即为自然人信息数据模型，而自然人的数据模型可以将其看成一个信息树，一个患者可以看成是一棵树，而他的信息可以看成是树叶，一片树叶是一个人的某个特定的信息，每个人的信息具体数值可能都有不同，但是叶子的信息指的是什么这是一定的。例如，这片叶子代表的是身高，那么每个人的这片叶子都是身高，但是身高是多少，则根据每个人的具体值而定。而这个每一片叶子代表什么也需要我们去定义，具体如何定义的参见如下

结构定义如下图

![](/media/自然人结构图.png)

而这些标准都是需要存入数据中，具体存入结构如何，参见下面**数据库设计df_metadata表**

## 模型设计

由上面的描述我们知道了自然人的数据的节点的定义需要落地到数据库中，这些定义数据则是为元数据，那么存储数据的表则叫元数据表

### 元数据表：df_metadata

| 字段                      | 类型        | 备注                                       |
| ----------------------- | --------- | ---------------------------------------- |
| id                      | long      | 唯一标志                                     |
| code                    | string    | 优护家唯一编码                                  |
| name                    | string    | 元数据名称                                    |
| description             | string    | 元数据描述                                    |
| data_type               | long      | 数据项数据类型:枚举值，具体代表含义 1. string 2. int 3. float 4. bool 5. unary 6. date |
| expiration              | long      | 数据项数据失效时间，是一个相对时间，相对于df_data_item.generated_at （数据真实产生时间），单位，毫秒 |
| standard_display_format | string    | 数据项数据标准显示格式                              |
| standard_unit           | string    | 数据项数据标准单位（如kg、g等）                        |
| standard_mapping        | string    | 元数据和其他国际标准对应的编码 json 格式 例如： {"icd-10":"A03-1"} |
| created_at              | TIMESTAMP | 创建时间                                     |
| updated_at              | TIMESTAMP | 修改时间                                     |



### 元数据数据落地：

1. 优护家元数据唯一code编码确定：
   一级：YHJ、
   二级：YHJ.AA——YHJ.ZZ、
   三级：YHJ.AA.001——YHJ.ZZ.999、
   四级：YHJ.AA.001.001——YHJ.ZZ.999.999、
   .....
   十级：YHJ.AA.001.001.001.001.001.001.001.001——YHJ.ZZ.999.999.999.999.999.999.999.999

2. 需要整理自然人的所有数据，以及入库。

数据库数据示例：

![](/media/元数据数据库实例数据.png)

### 自然人数据项： df_data_item

自然人的数据：由自然人的唯一标志符和数据项的集合组成，唯一标志符即下面的user_id，一个user_id会对应多条数据项

| 字段                | 类型        | 描述              |
| ----------------- | --------- | --------------- |
| id                | long      | 该条数据的唯一标志       |
| user_id           | long      | 自然人的id          |
| df_metadata_code  | string    | 元数据编码           |
| value             | string    | 具体的值，应该是经过序列化的  |
| is_valid          | bit       | 默认为1，1:为有效,2:无效 |
| provider          | long      | 数据收集方           |
| collecting_method | long      | 数据收集方法          |
| collector         | long      | 数据收集器           |
| generated_at      | TimeStamp | 数据真实产生的时间       |
| collected_at      | TimeStamp | 收集器收集数据时间       |
| created_at        | TimeStamp | 入库时间            |
| updated_at        | TimeStamp | 修改时间            |


#### 字段补充说明：

**provider:** 数据的提供方，现在已知的枚举如下，

```java
public enum ProviderEnum {
    OTHER(1, "其他"),
    YHJ(2, "优护家"),
    WN(3, "卫宁");
 }
```

**collecting_method:** 数据的收集方法

```java
public enum CollectingMethodEnum {
    OTHER(1, "其他"),
    SYSTEM(2, "系统录入"),
    NURSE_EVALUATION(3, "护士评估"),
    SELF_TEST_EVALUATION(4, "自测评估"),
}
```

**collector:** 数据的收集器

```java
public enum CollectorEnum {
  OTHER(1, "其他"),
  YHJ_WEXIN_PUB_C_END(2, "优护C端"),
  YHJ_APP_END(3, "优护助手"),
  SPHYGMOMANOMETER(4, "血压计");
}
```

### MySQL Migration

```MySQL
CREATE TABLE IF NOT EXISTS `df_metadata` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `code` VARCHAR(255) NOT NULL COMMENT '优护家元数据唯一编码',
  `name` VARCHAR(512) NOT NULL COMMENT '元数据名称',
  `description` LONGTEXT NOT NULL COMMENT '元数据描述',
  `data_type` BIGINT NOT NULL COMMENT '数据项数据类型, 见 DateTypeEnum',
  `expiration` BIGINT NULL COMMENT '数据项数据失效时间，是一个相对时间，相对于 df_data.generated_at（数据真实产生时间），单位，毫秒',
  `standard_display_format` VARCHAR(512) NULL COMMENT '数据项数据标准显示格式',
  `standard_unit` VARCHAR(512) NULL COMMENT '数据项数据标准单位（如kg、g等）',
  `standard_mapping` VARCHAR(512) NULL COMMENT '元数据和其他国际标准对应的编码 json 格式 例如："icd-10"=>"A03-1"',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT,
  PRIMARY KEY (`id`),
  INDEX `df_metadata_code_idx` (`code` ASC),
  INDEX `df_metadata_data_type_idx` (`data_type` ASC),
  INDEX `df_metadata_expiration_idx` (`expiration` ASC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


CREATE TABLE `df_data`(
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '数据项主键',
  `df_metadata_code` VARCHAR(255) NOT NULL COMMENT '元数据编码',
  `value` LONGTEXT NULL COMMENT '具体的值，可能是经过序列化的',
  `is_valid` BIT NOT NULL DEFAULT 1 COMMENT '默认为1，0:无效,1:有效',
  `provider` BIGINT NOT NULL COMMENT '数据收集方',
  `collecting_method` BIGINT  NOT NULL COMMENT '数据收集方法',
  `collector` BIGINT NOT NULL COMMENT '数据收集器',
  `generated_at` TIMESTAMP NOT NULL COMMENT '数据真实产生时间',
  `collected_at` TIMESTAMP NOT NULL COMMENT '收集器时间',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  INDEX `df_data_user_id_idx` (`user_id` ASC),
  INDEX `df_data_df_metadata_code_idx` (`df_metadata_code` ASC),
  INDEX `df_data_is_valid_idx` (`is_valid` ASC),
  INDEX `df_data_provider_idx` (`provider` ASC),
  INDEX `df_data_collecting_method_idx` (`collecting_method` ASC),
  INDEX `df_data_collector_idx` (`collector` ASC),
  INDEX `df_data_generated_at_idx` (`generated_at` ASC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

### 接口设计

暂不提供查询接口，只提供一个批量写入接口。

#### 1. 批量录入数据项
> POST /api/hibernation/v1/data/bulk

* Request

  ```json
  {
    "data": [
      {
        "userId": 1,
        "DFMetadataCode": "YHJAA.001.001",
        "value": "路过",
        "provider": 1,
        "collecting_method": 1,
        "collector": 1,
        "generatedAt": "1491041660000",
        "collectedAt": "1491041660000"
      }
    ]
  }
  ```

* Response

  ```json
  {
    "result": {
      "code": 0,
      "success": true
    },
    "data": [
      {
        "DFDataId": 1
        "userId": 1,
        "DFMetadataCode": "YHJAA.001.001",
        "value": "路过",
        "provider": 1,
        "collecting_method": 1,
        "collector": 1,
        "generatedAt": "1491041660000",
        "collectedAt": "1491041660000"
      }
    ]
  }
  ```

#### Protobuf 定义

```protobuf
message DFData {
    optional int64 dataId = 2;
    optional int64 userId = 3;
    optional string DFMetadataCode = 4;
    optional string value = 5;
    optional ProviderEnum provider = 6;
    optional CollectingMethodEnum collectingMethod = 7;
    optional CollectorEnum collector = 8;
    optional int64 generatedAt = 9;
    optional int64 collectedAt = 10;
}

message DataListDTO {
    optional Result result = 1;
    repeated DFData data = 2;
}

message BulkCreateDataOption {
  repeated BulkCreateData data = 1;

  repeated BulkCreateData {
    optional int64 userId = 1;
    optional string DFMetadataCode = 2;
    optional string DFDataItemValue = 3;
    optional int64 provider = 4;
    optional int64 collectingMethod = 5;
    optional int64 collector = 6;
    optional int64 generatedAt = 7;
    optional int64 collectedAt = 8;
  }
}

enum DataTypeEnum {
  STRING = 1;
  INT = 2;
  FLOAT = 3;
  BOOL = 4;
  UNARY = 5;
  DATE = 6;
}

enum ProviderEnum {
  YHJ = 1; // 优护家
  WEI_NING = 2; // 卫宁
  OTHER = 3; // 其它
}

enum CollectingMethodEnum {
  SYSTEM = 1; // 系统
  NURSE_EVALUATION = 2; // 护士评估
  SELF_TEST_EVALUATION = 3; // 自测评估
  OTHER = 4; // 其它
}

enum CollectorEnum {
  YHJ_APP_NURSE_END = 1; // 优护助手护士端
  YHJ_WEXIN_PUB_C_END = 2; // 优护助手微信公众号C端
  SPHYGMOMANOMETER = 3; // 血压计
  OTHER = 4; // 其它
}
```

## Hibernation 开发排期

| 内容                   | 时间   | 开发者  |
| -------------------- | ---- | ---- |
| Metadata 相关接口开发      | 1    | 黄英   |
| Data 相关接口开发          | 1    | 黄英   |
| 录入数据接口               | 1    | 黄英   |
| 自然人模型数据录入（不包括 ICD10) | 1    | 黄英   |
| ICD10 疾病树 数据录入「/     | 1    | 黄英   |
