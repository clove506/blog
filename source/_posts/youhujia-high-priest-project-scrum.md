---
title: High Priest 项目 PRD 及开发日志
date: 2017-2-15 16:00:00
categories: 自动化平台
tags:
- PRD
- High Priest
- 容器服务
- 阿里云
---

### 摘要
High Priest 项目分两期做，包括：

- 迁移现有服务到「阿里云容器服务」；
- 开发自动化管理平台，完成自动测试、部署、上线、监控等。

### Wiki 维护人
田学文

### 1. 迁移服务到阿里云容器服务
这部分内容包括两部分：
1. 自动部署依赖服务
2. 阿里云容器服务迁移

具体如下。

#### 1.1 自动部署依赖服务

- Maven 私有源部署，发布例如 youhujia-halo 到私有源，方便自动化部署。

#### 1.2 阿里云容器服务迁移

- `build.gradle` 重构;
- 将 docker image 部署到容器中，提供可用的**服务**；
- 调度服务，实现服务数量可横向扩展
- 开发者日程开发、调试支持
- 服务升级版本
- 服务版本回滚
- 线上环境迁移

**build.gradle**重构
在项目开发完毕后，可以通过运行

- gradle buildDocker
- gradle pushDocker

完成对 Docker 化的代码交付，即交付项目的 *docker image*

**image 部署**
项目的第一次部署手动完成。通过编辑「编排模板」来完成容器服务从「模板」到节点运行「容器实例」的部署过程。

其实就是 docker compose/swarm

包括：

- 模板编写
- 参数定制
- 容器运行参数定制
- 部署

**服务数量调度**
修改容器服务的数量，例如 `owl` 服务由1个实例扩展为3个，反之亦然。

**开发者日程开发、调试支持**
支持日常环境开发，主要实现：

- 服务本地运行，配合在阿里云容器服务中运行的其他服务一起联调，即实现 mac 下运行服务和阿里云服务的互通；
- 完全关闭阿里云容器服务中的某个服务，完全由本地的 java 实例提供服务。

**服务升级版本**
即使用 rolling update 完成服务版本升级，使用新的 image 替换现有的服务。

**服务版本回滚**
回滚服务到老版本，应对线上紧急情况。通 rolling update，即使用老的 image 替换现有的服务。

**线上环境迁移**
将现有的 center01 上的所有服务迁移到阿里云容器服务下。步骤如下：

- 迁移 staging 环境并测试
- 部署 production 环境
- 利用SLB将流量导入至容器服务环境
- 测试，有问题立即将流量全部导至原有环境，实现及时回滚

**Maven 源**

- 自动发布 jar
- CI 自动 生成 tag， version++

**上线流程**
容器环境 & CI 环境下，新的上线流程。

**潜在问题**
- DNA 多实例冲突


### 2. 自动化平台
实现以下功能的自动化。

- 代码检查
- 代码测试
- 代码交付
- 测试环境调试、测试
- 预演环境发布、回滚
- 线上环境发布、回滚
- 前端 CI+CD 方案
- App 测试、集成、发布方案

第二期做。


### 3. 排期

内容|耗时/人日|人员
---|---|---
私有源 & build.gradle 重构|1|田学文
image 部署|0.5|赵蔺
服务数量调度|0.5|赵蔺
开发者日程开发、调试支持|1|赵蔺
服务升级版本、服务版本回滚|1|赵蔺
线上环境迁移|2|赵蔺、田学文
上线流程|1|赵蔺

总计7人日


