---
title: C端2.0 Yolar Refactor
date: 2017-4-15 14:20:00
categories: C++
tags:
- Yolar
---

## 背景

### 2016年的往事
Yolar 在第一版设计的时候，有个 Person 表，初衷是为了方便统一人物模型，能够将 `User`, `Nurse`, `Admin` 统一为抽象的 `Person`,  能够将这三者的公共属性统一处理，比如：

- phone
- wechat_profile
- token

同时，利用以上模型，还完成了譬如访客科室的模型，即多个 `Nurse` 关联同一个 `Person`，可以认为同一个护士有多个科室的身份。

这三个基本属性都能存储在 Person 表中。确实这个方案做到了，但是同时带来以下几个问题：

- `Nurse` 和 `User` 手机一样时，头像和 `token` 是公用的。 会造成一个尴尬的现象：护士在 C 端登陆后，发现自己的头像变成了微信的头像
- 患者如果完成个人信息，比如手机号，合并数据时，会带来一些意想不到的复杂情况，需要考虑的分支特别多，容易出 Bug

所以，需要将`Person`的模型简化。

### 简化重构方案

简单来说，就是移除 `Person`, 将原本 `Person` 中的数据转移到 `User`, `Nurse`, `Admin` 中去。然后删除 `wechat_profile`

**护士**
访客科室的逻辑不变，即护士更换科室就新建一个 Nurse 记录。

更换科室的逻辑改为登录时选择科室，即带上科室信息。

**患者**
患者关联科室由 `user_department` 表描述关系。

### 项目结构调整

目前 Era 中，有太多的关于人的接口，压力比较重，需要 Era 拆分：

- 关于患者的接口拆出来放到**Shooter**中去；
- 关于 Nurse 端(B端) 的接口放到**Farmer**中去。
- 将原 Era 中的 Admin相关接口放入**Gravitation** 中


| 项目          | 内容                           |
| ----------- | ---------------------------- |
| Era         | 删除                           |
| Yolar       | 所有和患者、护士、管理员的底层接口，包括统一登录相关接口 |
| Solar       | 所有科室接口                       |
| Gravitation | 护士运营管理项目                     |
| Shooter     | 面向 C 端的业务系统                  |
| Farmer      | 面向护士端 B 端的业务系统               |

## 模型设计
**person**

- name
- avatarUrl
- phone
- token
- gender
- birthday


**User 患者**

- id， 即 user_id
- name 姓名
- phone 手机
- token
- gender 性别
- birthday 生日
- real name 真实姓名
- ID card 身份证号
- status 状态
- flag ???

**Nurse 护士**

- id, 即 nurse_id
- organization_id
- department_id
- active 是不是激活
- name 姓名
- status 状态
- certs 职业证书
- title 职称

**Wechat Profile 微信信息**

删除原来的 `person_id` 字段，加入以下两个字段来定位一个患者、护士或者管理员。

- person_id
- person_type


## Solar 项目

将原来 Yolar 项目中的以下几个表和相关逻辑迁出，置于 Solar 项目。

- `organization` 表
- `department` 表

## Era 项目

鉴于面向业务的部分功能更加明确，业务已经基本分为以下几类：

- 面向患者（C 端）的业务接口，也就是现在的 Shooter
- 面向护士的优护助手 App （Nurse）的业务接口，也就是 Farmer
- 面向管理端（Admin）的业务接口，项目就比较多了

### 迁入到 Shooter 的接口

- OrganizationController 删除，不需要，有 Solar 提供底层接口
- DepartmentController
- UserController

### 迁入到 Farmer 的接口

- NurseController

### 迁入到 Gravitation 的接口

- AdminController

### 迁入到 Yolar 的接口

将 Era 中所有关于登录的接口迁移至 Yolar。

## 接口说明

### Shooter
| 接口   | 内容            | Protobuf                      | URL                                      |
| ---- | ------------- | ----------------------------- | ---------------------------------------- |

**Protobuf**


### Farmer
| 接口   | 内容          | Protobuf                                 | URL                                      |
| ---- | ----------- | ---------------------------------------- | ---------------------------------------- |
| 登出   | 登出          | COMMON.SimpleResponse                    | POST /api/nurses/signout                 |
| 基本信息 | 获取护士信息      | NurseInfoDTO                             | GET /api/nurses//{id}/info               |
|      | 更新护士信息      | COMMON.SimpleResponse,NurseInfoOption    | PATCH /api/nurses/{nurseId}/info         |
|      | 发送邀请短信      | COMMON.SimpleResponse                    | POST /api/nurses/{nurseId}/invite-via-sms |
|      | 获取护士同事列表    | NursesClassfiedByTagDTO                  | GET /api/nurses/{nurseId}/colleagues     |
|      | 获取患者列表      | UsersClassfiedByTitleDTO                 | GET /api/nurses/{nurseId}/patients       |
|      | 获取黑名单列表     | TagAndCategoryDTO                        | GET /api/nurses/{nurseId}/patients/blacklist |
|      | 创建患者 Tag    | TagAndCategoryDTO,TagAndCategoryOption   | POST /api/nurses/users/tags              |
|      | 删除患者 Tag    | TagAndCategoryDTO,TagAndCategoryOption   | POST /api/nurses/users/tags/delete       |
|      | 更新患者 Tag    | TagAndCategoryDTO,TagAndCategoryOption   | PATCH /api/nurses/users/tags             |
|      | 创建患者 Tag 分组 | TagAndCategoryDTO,TagAndCategoryOption   | POST /api/nurses//users/tags/categories  |
|      | 更新患者关联的 Tag | TagAndCategoryDTO,TagAndCategoryOption   | PATCH /api/nurses/users/{userId}/tags    |
|      | 批量更新患者 Tag  | BulkTagAndCategoryDTO,BulkTagAndCategoryOption | PATCH /api/nurses/users/bulk/tags        |
|      | 获取患者信息      | UserInfoWithTagsDTO                      | GET /api/nurses/users/{userId}/info      |
|      |             |                                          |                                          |

**Protobuf**
```protobuf
message NurseSigninDTO {
    optional string token = 1;
    optional bool newly = 2;
    optional NurseBasic nurse = 3;

    optional Result result = 4;
}

message NurseInfoDTO {
    optional NurseBasic basic = 1;
    optional NurseOccupation occupation = 2;

    optional Result result = 3;
}

message TagAndCategoryDTO {
    repeated Tag tag = 1;
    optional int64 userId = 2;

    optional Result result = 3;
}

message TagAndCategoryOption {
    repeated Tag tag = 1;
    optional int64 userId = 2;
}

message Tag {
    optional int64 tagId = 1;
    optional string tagName = 2;
    optional int64 tagCategoryId = 3;
    optional string tagCategoryName = ;
}

message NursesClassfiedByTagDTO {
    repeated TagGroup nurse = 1;
    repeated NurseInfoWithTagsDTO all = 2;

    optional Result result = 3;

    message TagGroup {
        optional int64 tagId = 1;
        optional string tagName = 2;
        repeated NurseInfoWithTagsDTO member = 3;
    }
}

message NurseInfoWithTagsDTO {
    optional int64 nurseId = 1;
    optional string name = 2;
    optional string avatarUrl = 3;
    optional string identifier = 4;
    optional string professionalTitle = 5;
    optional NurseOccupation occupation = 6;
    repeated Tag tag = 7;

    optional Result result = 8;
}


message UserTagClassfiedDTO {
    repeated TagCategory tag = 1;

    optional Result result = 2;
}

message UsersClassfiedByTitleDTO {
    repeated NameGroup user = 1;

    optional Result result = 2;

    message NameGroup {
        optional string title = 1;
        repeated UserInfoWithTagsDTO member = 2;
    }
}

message TagAndCategoryUserDTO {
    optional Result result = 1;

    repeated TagAndCategoryDTO userTag = 2;
}

message TagAndCategoryUserOption {
    repeated TagAndCategoryDTO userTag = 2;
}

message NurseTagAndCategoryDTO {
    repeated TagAndTagCategory tags = 1;

    optional Result result = 2;

    message TagAndTagCategory {
        optional int64 tagId = 1;
        optional string tagName = 2;
        optional int64 tagCategoryId = 3;
        optional string tagCategoryName = 4;
    }
}

message UserInfoWithTagsDTO {
    optional int64 userId = 1;
    optional string name = 2;
    optional int64 status = 3;
    optional string statusName = 4;
    optional string avatarUrl = 5;
    optional string identifier = 6;
    optional string signature = 7;
    optional PatientRecord patientRecord = 8;
    repeated Tag tag = 9;
    optional UserTagClassfiedDTO departmentTag = 10;

    optional Result result = 11;
}

message PhoneCaptchaOption {
    optional string phone = 1;
    optional string captcha = 2;
}

message NurseInfoOption {
    optional NurseBasic basic = 1;
    optional NurseOccupation occupation = 2;
}
```

### Gravitation
| 接口   | 内容         | Protobuf                         | URL                                      |
| ---- | ---------- | -------------------------------- | ---------------------------------------- |
| 组织机构 | 创建医院       | OrganizationDTO                  | POST /api/era/v1/admin/organizations     |
|      | 更新医院       | OrganizationDTO                  | PATCH /api/era/v1/admin/organizations    |
|      | 创建科室       | DepartmentDTO                    | POST /api/era/v1/admin/departments       |
|      | 更新科室       | DepartmentDTO                    | PATCH /api/era/v1/admin/departments      |
|      | 获取所有科室     | OrganizationAndDepartmentListDTO | GET /api/era/v1/admin/departments        |
|      | 获取科室活动护士   | NurseInfoListDTO                 | GET /api/era/v1/admin/departments/{departmentId}/active-nurse |
|      | 更新护士信息     | COMMON.SimpleResponse            | PATCH /api/era/v1/admin/nurses/{nurseId} |
|      | 获取或创建科室二维码 | String                           | POST /api/era/v1/admin/nurses/msg/wx/qrcode |
|      | 获取科室二维码    | String                           | GET /api/era/v1/admin/nurses/msg/wx/qrcode-list |

**Protobuf**

```protobuf
message OrganizationDTO {
    optional OrganizationOption organization = 1;
    optional int64 createdAt = 2;
    optional int64 updatedAt = 3;

    optional Result result = 4;
}

message OrganizationOption {
    optional int64 organizationId = 1;
    optional string organizationName = 2;
    optional int64 createdAt = 3;
    optional int64 updatedAt = 4;
    repeated DepartmentOption department = 5;
}

message DepartmentDTO {
    optional DepartmentOption department = 1;
    optional int64 createdAt = 2;
    optional int64 updatedAt = 3;

    optional Result result = 4;
}

message DepartmentOption {
    optional int64 departmentId = 1;
    optional string departmentName = 2;
    optional int64 organizationId = 3;
    optional string organizationName = 4;
    optional int64 createdAt = 5;
    optional int64 updatedAt = 6;

    optional string departmentWxQrCode = 7;

    optional bool isGuest = 8;
}

message OrganizationAndDepartmentListDTO {
    repeated OrganizationOption organization = 1;
    optional Result result = 2;
}

message NurseInfoListDTO {
    repeated NurseInfoDTO nurse = 1;

    optional Result result = 2;
}

message NurseInfoDTO {
    optional NurseBasic basic = 1;
    optional NurseOccupation occupation = 2;

    optional Result result = 3;
}

message NurseBasic {
    optional int64 id = 1;
    optional string name = 2;
    optional string avatarUrl = 3;
    optional string phone = 4;
    optional string authorizedName = 5;
    optional int64 authorizedStatus = 6;
    optional int64 organizationId = 7;
    optional string organizationName = 8;
    optional int64 departmentId = 9;
    optional string departmentName = 10;
    optional string professionalTitle = 11;
    optional string qrImgUrl = 12;
    optional string identifier = 13;
    optional int64 createdAt = 14;
    optional int64 updatedAt = 15;
    optional bool active = 16;
}

message NurseOccupation {
    optional string IDNumber = 1;
    optional string certs = 2;
    optional string photocopy = 3;
}
```



### Yolar
| 接口   | 内容            | Protobuf                                 | URL                                      |
| ---- | ------------- | ---------------------------------------- | ---------------------------------------- |
| 验证码  | 获取手机验证码       | COMMON.SimpleResponse,PhoneCaptchaOption, | POST /api/yolar/v1/login/phone/captcha   |
| 登录   | 手机密码登录        | SimpleLoginDTO,SimpleLoginOption         | POST /api/yolar/v1/login/phone-password  |
|      | 手机验证码登录       | SimpleLoginDTO,SimpleLoginOption         | POST /api/yolar/v1/login/phone-captcha   |
|      | 手机密码重置        | COMMON.SimpleResponse,SimpleLoginOption  | POST /api/yolar/v1/login/reset-password  |
|      | 微信登录          | UserSignInDTO                            | POST /api/era/v1/users/signin/{code}     |
|      | 微信账户迁移        | MigrateWxDTO                             | POST /api/era/v1/users/migrate-old-wx/{code} |
|      | 合肥用户登录        | HefeiUserDTO,HefeiLoginOption            | POST /api/era/v1/pc/user/hefei/login     |
|      | 检查影子公众号用户是否存在 | RedirectResponseDTO                      | POST /api/era/v1/users/shadow-wx/exist   |
|      | 保存影子公众号的用户    | RedirectResponseDTO                      | POST /api/era/v1/users/shadow-wx         |


**Protobuf**
```protobuf
message PhoneCaptchaOption {
    optional string phone = 1;
    optional string captcha = 2;
}

message SimpleLoginOption {
    optional string phone = 1;
    optional string password = 2;
    optional string captcha = 3;
    optional int32 loginRole = 4;
}

message HefeiLoginOption {
    optional string phone = 1;
    optional string password = 2;
    optional string captcha = 3;
}

message UpdateUserOption{
    optional string phone = 1;
    optional string name = 2;
    optional string gender = 3;
    optional int64 birthday = 4;
    optional string captcha = 5;
}

message UserSignInDTO {
    optional Result result = 1;

    optional string token = 2;
    optional string redirectUrl = 3;
}

message MigrateWxDTO {
    optional Result result = 1;

    optional string token = 2;
}

message HefeiUserDTO{
    optional Result result = 1;
    optional UserInfo userInfo = 2;
    optional bool needModify = 3;
}

message UpdateUserDTO {
    optional Result result = 1;
    optional UserInfo userInfo = 2;
}

message Yolar.RedirectResponseDTO {
  	optional Result result = 1;
  	optional string redirectUrl =2;
}

message UserInfo{
    optional int64 userId = 1;
    optional string phone = 2;
    optional string name = 3;
    optional string gender = 4;
    optional int64 birthday = 5;
    optional string idCard = 6;
    optional Address address = 7;
    optional string token = 8;
}
```




1. dpt 服务 tag
2. 护士提供服务 tag
3. 护士可选服务 tag
4. 护士通知 tag

yolar dagon.x8 —> tag